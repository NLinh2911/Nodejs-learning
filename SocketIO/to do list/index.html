<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Todo List</title>
	<link rel="stylesheet" type="text/css" href="assets/css/todos.css">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,700,500' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.css">
</head>

<body>

	<div id="container">
		<h1>To-Do List <i class="fa fa-plus"></i></h1>
		<input type="text" placeholder="Add New Todo">

		<ul>
		</ul>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!--<script type="text/javascript" src="assets/js/todos.js"></script>-->
	<script src="/socket.io/socket.io.js"></script>
	<script>
		$(function () {

			//=======================================
			//SOCKET IO 
			//========================================
			// connect to socket.io
			const socket = io();

			// new client is requested to register an username
			const username = prompt("What's your username?");
			console.log(username);
			// send to server
			socket.emit('new_client', username);
			// display in browser's title and on pages
			document.title = username + ' - ' + document.title;

			// display an announcement when a new user connects
			socket.on('new_client', (username) => {
				alert(`${username} has joined the team to do list!`);
			});
			socket.on('update data', (data) => {
				console.log(data);
				data.forEach((todo) => {
					insertTodo(todo.id, todo.todo);
				})
			})
			//=======================================
			//JS FRONT END BEHAVIOUR
			//========================================
			// insert to-do list on pages
			const insertTodo = (todoId, todoText) => {
				$("ul").append(`<li id="${todoId}"><span><i class='fa fa-trash'></i></span> ${todoText} </li>`);
			}
			// add a new to-do
			$("input[type='text']").keypress(function (event) {
				if (event.which === 13) {
					//grabbing new todo text from input
					let todoText = $(this).val();
					$(this).val("");
					//send data to server
					socket.emit('new_todo', todoText);
					return false;
				}
			});
			// receive data when 'new_todo' event happens
			socket.on('new_todo', (data) => {
				alert(`${data.username} adds a new to-do`);
				insertTodo(data.id, data.text);
			});

			// Check Off Specific Todos By Clicking
			$("ul").on("click", "li", function () {
				$(this).toggleClass("completed");
				//get the id of <li> to send to server
				let doneId = $(this).attr('id');
				socket.emit('done_todo', doneId);
			});
			// receive data when 'done_todo' happens
			socket.on('done_todo', (data) => {
				let doneText = $('#' + data.id).text();
				alert(`${data.username} finishes "${doneText}" to-do`);
				$("#" + data.id).toggleClass("completed");
			});

			//Click on X to delete Todo
			$("ul").on("click", "span", function (event) {
				$(this).parent().fadeOut(500, function () {
					//get the id of <li> to send to server
					let deletedId = $(this).attr('id');
					socket.emit('delete_todo', deletedId);
					$(this).remove();
				});
				event.stopPropagation();
			});
			// receive data when 'delete_todo' happens
			socket.on('delete_todo', (data) => {
				let deletedText = $('#' + data.id).text();
				alert(`${data.username} deletes "${deletedText}" to-do`);
				$('#' + data.id).remove();
			});


			$(".fa-plus").click(function () {
				$("input[type='text'").fadeToggle()
			});

		});
	</script>
</body>

</html>